"use strict";var t,e=Object.create,r=Object.defineProperty,a=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,o=Object.getPrototypeOf,i=Object.prototype.hasOwnProperty,n=(t,e,o,n)=>{if(e&&"object"==typeof e||"function"==typeof e)for(let h of s(e))i.call(t,h)||h===o||r(t,h,{get:()=>e[h],enumerable:!(n=a(e,h))||n.enumerable});return t},h=(t,a,s)=>(s=null!=t?e(o(t)):{},n(!a&&t&&t.__esModule?s:r(s,"default",{value:t,enumerable:!0}),t)),d={};((t,e)=>{for(var a in e)r(t,a,{get:e[a],enumerable:!0})})(d,{Color:()=>u,HeatTrace:()=>B,loadReplay:()=>f}),module.exports=(t=d,n(r({},"__esModule",{value:!0}),t));var l,c=h(require("worker_threads"));(l||(l={})).getGradientColor=function(t,e){const r=1/(e.length-1);let a=Math.floor(t/r);return a>=e.length&&(a=e.length-1),function(t,e,r){let a=Math.round(t.r+(e.r-t.r)*r),s=Math.round(t.g+(e.g-t.g)*r),o=Math.round(t.b+(e.b-t.b)*r);return a>255&&(a=255),s>255&&(s=255),o>255&&(o=255),{r:a,g:s,b:o}}(e[a],e[a+1]||e[a],t%r/r)};var u=l,p=require("lzma-native"),g=class{_data="";_index=0;constructor(t){t.forEach((t=>this._data+=t.toString(2).padStart(8,"0")))}readByte(){return parseInt(this._read(8),2)}readShort(){return _([this._read(8),this._read(8)],8)}readInteger(){return _([this._read(8),this._read(8),this._read(8),this._read(8)],8)}readLong(){return _([this._read(8),this._read(8),this._read(8),this._read(8),this._read(8),this._read(8),this._read(8),this._read(8)],8)}readULEB128(){const t=[];for(;;){const e=this._read(8);if(t.push(e.substring(1,8)),"0"===e[0])break}return _(t,7)}readString(){if(11===this.readByte()){const t=this.readULEB128();let e=[];for(let r=0;r<t;r++)e.push(parseInt(this._read(8),2));return Buffer.from(e).toString("utf8")}return""}_read(t){const e=this._data.substring(this._index,this._index+t);return this._index+=t,e}};function _(t,e){let r=0,a=0;for(let s=0;s<t.length;s++){r|=(parseInt(t[s],2)&(1<<e)-1)<<a,a+=e}return r}async function f(t){return new Promise((e=>{const r=new g(t),a=r.readByte(),s=r.readInteger(),o=r.readString(),i=r.readString(),n=r.readString(),h=r.readShort(),d=r.readShort(),l=r.readShort(),c=r.readShort(),u=r.readShort(),_=r.readShort(),f=r.readInteger(),y=r.readShort(),b=r.readByte();r.readInteger(),r.readString(),r.readLong();const m=r.readInteger(),w=new Uint8Array(m);for(let t=0;t<m;t++)w[t]=r.readByte();const k={version:s,gameMode:["standard","taiko","catch","mania"][a],beatmapHash:o,replayHash:n,playerName:i,great:h,ok:d,meh:l,gekis:c,katus:u,misses:_,score:f,greatestCombo:y,perfect:1===b};(0,p.decompress)(Buffer.from(w),void 0,(t=>{const r=t.toString().split(","),a=new Float64Array(r.length),s=new Float64Array(r.length),o=new Float64Array(r.length);let i=0;r.forEach(((t,e)=>{const r=t.split("|");i+=+r[0],a[e]=+r[1],s[e]=+r[2],o[e]=i})),k.cursor={xPositions:a,yPositions:s,timeStamps:o},e(k)}))}))}var y=h(require("os")),b=h(require("worker_threads")),m=(t,e)=>{let r=w(t);for(;e.includes(r);)r=w(t);return r};function w(t){let e="";for(let s=0;s<t;s++)e+=k[(r=0,a=k.length-1,Math.floor(Math.random()*a)+r)];var r,a;return e}var k="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ123456789",j=class{_workers={};_requests={};_batches={};async startWorkers(t){const e=[];for(let r=0;r<t;r++){const t=m(5,Object.keys(this._workers));this._workers[t]={state:"starting",worker:new b.default.Worker(__filename,{workerData:{type:"HeatTrace"}})},e.push(this._handleWorker(t))}await Promise.all(e)}stopWorkers(){Object.keys(this._workers).forEach((t=>this._workers[t].worker.terminate())),this._workers={}}createBatch(t,e,r){return new Promise((a=>{const s={type:t,totalJobs:e.length,jobs:{},results:[],progressCallback:r,finishCallback:a};e.forEach((t=>s.jobs[m(5,Object.keys(s.jobs))]={state:"waiting",data:t})),this._batches[m(5,Object.keys(this._batches))]=s,this._assignJobs()}))}async sendRequest(t,e){return new Promise((r=>{const a=m(5,Object.keys(this._requests));this._requests[a]=r,this._sendMessage(t,{type:"request",data:e,requestID:a})}))}_sendMessage(t,e){if(void 0===this._workers[t])throw new Error(`Worker Not Found: "${t}"`);this._workers[t].worker.postMessage(e)}_assignJobs(){for(let t of Object.keys(this._workers)){const e=this._workers[t];if("readied"===e.state){const r=this._getJob();if(void 0===r)break;const a=this._batches[r.batchID];e.state="working",a.jobs[r.jobID].state="inProgress",this._sendMessage(t,{type:"assignJob",batchID:r.batchID,batchType:a.type,jobID:r.jobID,data:a.jobs[r.jobID].data})}}}_getJob(){for(let t of Object.keys(this._batches)){const e=this._batches[t];for(let r of Object.keys(e.jobs))if("waiting"===e.jobs[r].state)return{batchID:t,jobID:r};break}}async _handleWorker(t){if(void 0===this._workers[t])throw new Error(`Worker Not Found: "${t}"`);return new Promise((e=>{const r=this._workers[t];r.worker.on("message",(async t=>{if("ready"===t.type)r.state="readied",e();else if("jobFinished"===t.type){const e=this._batches[t.batchID];delete e.jobs[t.jobID],e.results.push(t.data),void 0!==e.progressCallback&&e.progressCallback({total:e.totalJobs,finished:e.totalJobs-Object.keys(e.jobs).length}),r.state="readied",this._assignJobs(),0===Object.keys(e.jobs).length&&(e.finishCallback(e.results),delete this._batches[t.batchID])}}))}))}},I=class{_state="none";_options;_style;_replaysCursorData=[];_length=0;WorkerManager=new j;constructor(t){this._options=t||{};const e=this.options.style||{};this._style={traceSize:e.traceSize||1,heatBoost:e.traceSize||1.75,colors:e.colors||[{r:0,g:0,b:0},{r:106,g:4,b:15},{r:208,g:0,b:0},{r:232,g:93,b:4},{r:250,g:163,b:7},{r:255,g:255,b:255}]},void 0===this._options.style&&(this._options.style={})}get state(){return this._state}get options(){return this._options}async initialize(){if("none"!==this._state)throw new Error(`Cannot Initialize HeatTrace: ${this._state}`);this._state="initializing",await this.WorkerManager.startWorkers(this._options.threads||y.default.cpus().length/2),this._state="initialized"}async loadReplays(t,e){if("initialized"!==this._state)throw new Error(`Cannot Load Replays: ${this._state}`);const r=await this.WorkerManager.createBatch("loadReplays",t,(t=>{void 0!==e&&e({total:t.total,loaded:t.finished})})),a=[];let s,o=0,i=0;for(let t of r)if(t.error)i++;else{if(void 0===s)s=t.data.beatmapHash;else if(t.data.beatmapHash!==s)return{error:!0,message:"Found Replays With Different Beatmaps"};t.data.timeStamps[t.data.timeStamps.length-1]>o&&(o=t.data.timeStamps[t.data.timeStamps.length-1]),a.push({xPositions:t.data.xPositions,yPositions:t.data.yPositions,timeStamps:t.data.timeStamps})}return this._replaysCursorData=a,this._length=o,{error:!1,data:{failed:i}}}async renderImage(t){if("initialized"!==this._state)throw new Error(`Cannot Calculate The Heatmap: ${this._state}`);const e=await this._calculateHeatmap(0,1/0,(e=>{void 0!==t&&t({type:"calculatingHeatmap",total:e.total,finished:e.finished})}));void 0!==t&&t({type:"rendering",total:1,finished:0});const r=(await this.WorkerManager.createBatch("renderImage",[{format:this._options.imageFormat||"png",width:this._options.width||512,height:this._options.height||384,heatmap:e,style:this._style}]))[0];return void 0!==t&&t({type:"rendering",total:1,finished:1}),r}async renderVideo(){}async _calculateHeatmap(t,e,r){if("initialized"!==this._state)throw new Error(`Cannot Calculate The Heatmap: ${this._state}`);const a=this._replaysCursorData.map((r=>({width:this._options.width||512,height:this._options.height||384,start:t,end:e,replayCursorData:r,style:this._style}))),s=await this.WorkerManager.createBatch("calculateHeatmaps",a,(t=>{void 0!==r&&r(t)}));return(await this.WorkerManager.createBatch("combineBeatmaps",[{width:this._options.width||512,height:this._options.height||384,heatmaps:s}]))[0]}},M=h(require("worker_threads")),S=(t,e,r,a,s)=>(t-e)/(r-e)*(s-a)+a,D=(t,e,r,a,s,o)=>{const i=new Map,n=Math.round((t+e)/750*o.traceSize);s.timeStamps.forEach(((o,h)=>{h>0&&o>=r&&o<=a&&function(t,e,r,a){const s=[],o=Math.abs(r-t),i=Math.abs(a-e),n=t<r?1:-1,h=e<a?1:-1;let d=o-i;for(;t!==r||e!==a;){s.push({x:t,y:e});let r=2*d;r>-i&&(d-=i,t+=n),r<o&&(d+=o,e+=h)}return s.push({x:r,y:a}),s}(Math.round(S(s.xPositions[h-1],0,512,0,t)),Math.round(S(s.yPositions[h-1],0,384,0,e)),Math.round(S(s.xPositions[h],0,512,0,t)),Math.round(S(s.yPositions[h],0,384,0,e))).forEach((t=>{if(n>1)for(let e=t.x-n;e<t.x+n;e++)for(let r=t.y-n;r<t.y+n;r++)P(i,e,r);else P(i,t.x,t.y)}))}));const h=new Uint32Array(3*i.size);let d=0;return i.forEach(((t,e)=>{const r=e.split(","),a=parseInt(r[0]),s=parseInt(r[1]);h[d]=a,h[d+1]=s,h[d+2]=t,d+=3})),h};function P(t,e,r){const a=`${e},${r}`;t.has(a)?t.set(a,t.get(a)+1):t.set(a,1)}var v=h(require("jimp"));function C(t){M.default.parentPort.postMessage(t)}var B=class{_Core;constructor(t){this._Core=new I(t)}async initialize(){await this._Core.initialize()}async loadReplays(t,e){return await this._Core.loadReplays(t,e)}async renderImage(t){return await this._Core.renderImage(t)}};c.default.isMainThread||"HeatTrace"!==c.default.workerData.type||(M.default.parentPort.on("message",(async t=>{if("assignJob"===t.type){const e=t.data;let r;if("loadReplays"===t.batchType){const t=await f(e);r="standard"!==t.gameMode?{error:!0,message:"Unsupport Game Mode"}:void 0===t.cursor?{error:!0,message:"Failed To Decompress Cursor Data"}:{error:!1,data:{beatmapHash:t.beatmapHash,xPositions:t.cursor.xPositions,yPositions:t.cursor.yPositions,timeStamps:t.cursor.timeStamps}}}else"calculateHeatmaps"===t.batchType?r=D(e.width,e.height,e.start,e.end,e.replayCursorData,e.style):"combineBeatmaps"===t.batchType?r=((t,e,r)=>{const a=new Uint32Array(t*e);r.forEach((e=>{for(let r=0;r<e.length;r+=3)a[e[r]+t*e[r+1]]+=e[r+2]}));let s=0;a.forEach((t=>{t>s&&(s=t)}));const o=new Float64Array(t*e);return a.forEach(((t,e)=>o[e]=S(t,0,s,0,1))),o})(e.width,e.height,e.heatmaps):"renderImage"===t.batchType&&(r=await(async(t,e,r,a,s)=>new Promise((o=>{const i=new Uint8Array(e*r*4);a.forEach(((t,e)=>{e*=4;const r=u.getGradientColor(S(t*s.heatBoost,0,1,0,1),s.colors);i[e]=r.r,i[e+1]=r.g,i[e+2]=r.b,i[e+3]=255})),new v.default(e,r,((e,r)=>{r.bitmap.data=Buffer.from(i),"png"===t?r.getBuffer(v.default.MIME_PNG,((t,e)=>o(e))):r.getBuffer(v.default.MIME_JPEG,((t,e)=>o(e)))}))})))(e.format,e.width,e.height,e.heatmap,e.style));C({type:"jobFinished",batchID:t.batchID,jobID:t.jobID,data:r})}else if("request"===t.type){let e;t.data,C({type:"response",data:e,requestID:t.requestID})}})),C({type:"ready"}));