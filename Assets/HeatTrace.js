"use strict";var e,t=Object.create,r=Object.defineProperty,a=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,o=Object.getPrototypeOf,i=Object.prototype.hasOwnProperty,n=(e,t,o,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of s(t))i.call(e,l)||l===o||r(e,l,{get:()=>t[l],enumerable:!(n=a(t,l))||n.enumerable});return e},l=(e,a,s)=>(s=null!=e?t(o(e)):{},n(!a&&e&&e.__esModule?s:r(s,"default",{value:e,enumerable:!0}),e)),h={};((e,t)=>{for(var a in t)r(e,a,{get:t[a],enumerable:!0})})(h,{HeatTrace:()=>q,loadReplay:()=>m}),module.exports=(e=h,n(r({},"__esModule",{value:!0}),e));var c=l(require("worker_threads")),d=require("lzma-native"),u=class{_data="";_index=0;constructor(e){e.forEach((e=>this._data+=e.toString(2).padStart(8,"0")))}readByte(){return parseInt(this._read(8),2)}readShort(){return p([this._read(8),this._read(8)],8)}readInteger(){return p([this._read(8),this._read(8),this._read(8),this._read(8)],8)}readLong(){return p([this._read(8),this._read(8),this._read(8),this._read(8),this._read(8),this._read(8),this._read(8),this._read(8)],8)}readULEB128(){const e=[];for(;;){const t=this._read(8);if(e.push(t.substring(1,8)),"0"===t[0])break}return p(e,7)}readString(){if(11===this.readByte()){const e=this.readULEB128();let t=[];for(let r=0;r<e;r++)t.push(parseInt(this._read(8),2));return Buffer.from(t).toString("utf8")}return""}_read(e){const t=this._data.substring(this._index,this._index+e);return this._index+=e,t}};function p(e,t){let r=0,a=0;for(let s=0;s<e.length;s++){r|=(parseInt(e[s],2)&(1<<t)-1)<<a,a+=t}return r}async function m(e){return new Promise((t=>{const r=new u(e),a=r.readByte(),s=r.readInteger(),o=r.readString(),i=r.readString(),n=r.readString(),l=r.readShort(),h=r.readShort(),c=r.readShort(),p=r.readShort(),m=r.readShort(),y=r.readShort(),g=r.readInteger(),f=r.readShort(),b=r.readByte();r.readInteger(),r.readString(),r.readLong();const w=r.readInteger(),_=new Uint8Array(w);for(let e=0;e<w;e++)_[e]=r.readByte();const x={version:s,gameMode:["standard","taiko","catch","mania"][a],beatmapHash:o,replayHash:n,playerName:i,great:l,ok:h,meh:c,gekis:p,katus:m,misses:y,score:g,greatestCombo:f,perfect:1===b};(0,d.decompress)(Buffer.from(_),void 0,(e=>{if(null===e)t(x);else{const r=e.toString().split(","),a=new Float64Array(r.length),s=new Float64Array(r.length),o=new Float64Array(r.length);let i=0;r.forEach(((e,t)=>{const r=e.split("|");i+=+r[0],a[t]=+r[1],s[t]=+r[2],o[t]=i})),x.cursor={xPositions:a,yPositions:s,timeStamps:o},t(x)}}))}))}var y=l(require("worker_threads"));function g(e,t,r,a){const s=new Float64Array(r.xPositions.length),o=new Float64Array(r.yPositions.length),i=new Float64Array(r.timeStamps.length);let n,l,h=0;return r.timeStamps.forEach(((e,t)=>{if(void 0===n||void 0===l){if(r.xPositions[t]<0||r.xPositions[t]>512||r.yPositions[t]<0||r.yPositions[t]>384)return;n=r.xPositions[t],l=r.yPositions[t]}else{if(Math.hypot(n-r.xPositions[t],l-r.yPositions[t])>a)return;n=r.xPositions[t],l=r.yPositions[t]}s[h]=n,o[h]=l,i[h]=e,h++})),{playerName:e,replayHash:t,xPositions:s.slice(0,h),yPositions:o.slice(0,h),timeStamps:i.slice(0,h)}}var f=l(require("jimp")),b=l(require("fs")),w=(e,t,r)=>e<t?t:e>r?r:e,_=async(e,t,r,a,s)=>new Promise((o=>{b.default.existsSync(e)?new f.default(e,((i,n)=>{if(null===i){const e=function(e,t,r,a,s){const o="min"===e?Math.min(a/t,s/r):Math.max(a/t,s/r);return{width:Math.round(t*o),height:Math.round(r*o)}}(t,n.getWidth(),n.getHeight(),r,a);n.resize(e.width,e.height);const i=new SharedArrayBuffer(n.bitmap.data.length),l=new Uint8Array(i);for(let e=0;e<n.bitmap.data.length;e+=4)l[e]=n.bitmap.data[e],l[e+1]=n.bitmap.data[e+1],l[e+2]=n.bitmap.data[e+2],l[e+3]=n.bitmap.data[e+3],void 0!==s.brightness&&(l[e]=w(l[e]-l[e]*(1-s.brightness),0,255),l[e+1]=w(l[e+1]-l[e+1]*(1-s.brightness),0,255),l[e+2]=w(l[e+2]-l[e+2]*(1-s.brightness),0,255));o({error:!1,texture:{width:e.width,height:e.height,data:i}})}else o({error:!0,message:`Failed To Load Texture: "${e}"`})})):o({error:!0,message:`Texture File Not Found: "${e}"`})}));var x,v=l(require("jimp")),k=(e,t,r,a,s)=>(e-t)/(r-t)*(s-a)+a;(x||(x={})).getGradientColor=function(e,t){const r=1/(t.length-1);let a=Math.floor(e/r);a>=t.length&&(a=t.length-1);const s=t[a],o=t[a+1]||t[a],i=e%r/r;let n=Math.round(s.r+(o.r-s.r)*i),l=Math.round(s.g+(o.g-s.g)*i),h=Math.round(s.b+(o.b-s.b)*i);return{r:Math.min(n,255),g:Math.min(l,255),b:Math.min(h,255)}};var M=x,j=class{static renderBackground(e,t,r,a){const s=new SharedArrayBuffer(Math.round(e*t*4)),o=new Uint8Array(s);if("color"===a.background.type)for(let e=0;e<o.length;e+=4)o[e]=w(a.background.color.r+255*a.background.brightness,0,255),o[e+1]=w(a.background.color.g+255*a.background.brightness,0,255),o[e+2]=w(a.background.color.b+255*a.background.brightness,0,255),o[e+3]=255;else if("image"===a.background.type){const s=r[a.background.image],i=e/2-s.width/2,n=t/2-s.height/2;this._drawTexture(o,e,t,s,Math.round(i),Math.round(n),255)}return{layer:0,pixels:s}}static renderHeatmap(e,t){const r=new Float64Array(e),a=new SharedArrayBuffer(4*r.length),s=new Uint8Array(a);return r.forEach(((e,r)=>{if(e>0){e=k(e*t.heatBoost,0,1,0,1),r*=4;const a=M.getGradientColor(e,t.colors);s[r]=w(a.r,0,255),s[r+1]=w(a.g,0,255),s[r+2]=w(a.b,0,255),s[r+3]=w(Math.round(k(e,0,1,255*t.traceOpacity[0],255*t.traceOpacity[1])),0,255)}})),{layer:1,pixels:a}}static renderCursors(e,t,r,a,s){const o=new SharedArrayBuffer(Math.round(e*t*4)),i=new Uint8Array(o),n="color"===s.cursor.type?s.cursor.colors.length:s.cursor.images.length;return r.forEach((r=>{let o=function(e){let t=0;for(let r=0;r<e.length;r++)t+=e.charCodeAt(r);return t}("player"===s.cursor.distribution?r.playerName:r.replayHash)%n;if(o>=n&&(o=n-1),"color"===s.cursor.type){const a=Math.round((e+t)/300*s.cursor.size);this._drawCircle(i,e,t,Math.round(k(r.x,0,512,0,e)),Math.round(k(r.y,0,384,0,t)),a,s.cursor.colors[o],255*s.cursor.opacity)}else"image"===s.cursor.type&&this._drawTexture(i,e,t,a[s.cursor.images[o]],Math.round(k(r.x,0,512,0,e)),Math.round(k(r.y,0,384,0,t)),255*s.cursor.opacity)})),{layer:2,pixels:o}}static async renderImage(e,t,r,a){return new Promise((s=>{const o=new Uint8Array(Math.round(t*r*4));a.sort(((e,t)=>e.layer-t.layer)).forEach((e=>{const t=new Uint8Array(e.pixels);for(let e=0;e<t.length;e+=4)if(t[e+3]>0){const r=Math.max(o[e+3],t[e+3]),a=k(t[e+3],0,r,0,1);o[e]=w(o[e]+(t[e]-o[e])*a,0,255),o[e+1]=w(o[e+1]+(t[e+1]-o[e+1])*a,0,255),o[e+2]=w(o[e+2]+(t[e+2]-o[e+2])*a,0,255),o[e+3]=w(255*a,0,255)}}));for(let e=0;e<o.length;e+=4)o[e+3]=255;if("raw"===e){const e=new SharedArrayBuffer(t*r*4);new Uint8Array(e).set(o,0),s(e)}else new v.default(t,r,((t,r)=>{r.bitmap.data=Buffer.from(o),"png"===e?r.getBuffer(v.default.MIME_PNG,((e,t)=>{const r=new SharedArrayBuffer(t.length);new Uint8Array(r).set(t,0),s(r)})):r.getBuffer(v.default.MIME_JPEG,((e,t)=>{const r=new SharedArrayBuffer(t.length);new Uint8Array(r).set(t,0),s(r)}))}))}))}static _drawCircle(e,t,r,a,s,o,i,n){for(let l=-o;l<=o;l++)for(let h=-o;h<=o;h++)if(l*l+h*h<=o*o){const o=Math.round(a+l),c=Math.round(s+h);if(o>=0&&o<t&&c>=0&&c<r){const r=4*(o+c*t);e[r]=w(i.r,0,255),e[r+1]=w(i.g,0,255),e[r+2]=w(i.b,0,255),e[r+3]=w(n,0,255)}}}static _drawTexture(e,t,r,a,s,o,i){const n=new Uint8Array(a.data);let l=0;for(let h=o;h<o+a.height;h++)for(let o=s;o<s+a.width;o++){if(o>=0&&o<t&&h>=0&&h<r){const r=4*(o+h*t);n[l+3]>0&&(e[r]=w(n[l],0,255),e[r+1]=w(n[l+1],0,255),e[r+2]=w(n[l+2],0,255),e[r+3]=w(i,0,255))}l+=4}}};var S=class{static calculateHeatmap(e,t,r,a,s,o,i){const n=new Uint32Array(e*t),l=Math.round((e+t)/900*i.traceSize);let h=o.xPositions[0],c=o.yPositions[0];const d=new Map;for(let s=0;s<o.timeStamps.length-1;s++)if(o.timeStamps[s]>=r&&o.timeStamps[s]<=a)h=o.xPositions[s],c=o.yPositions[s],d.clear(),C(Math.round(k(h,0,512,0,e)),Math.round(k(c,0,384,0,t)),Math.round(k(o.xPositions[s+1],0,512,0,e)),Math.round(k(o.yPositions[s+1],0,384,0,t))).forEach((r=>{if(l>1)if(l%2==0){const a=l/2-1,s=l/2;for(let o=r.x-a;o<=r.x+s;o++)for(let i=r.y-a;i<=r.y+s;i++)o>=0&&o<e&&i>=0&&i<t&&(d.has(`${o},${i}`)||(n[o+i*e]++,d.set(`${o},${i}`,!0)))}else{const a=(l-1)/2;for(let s=r.x-a;s<=r.x+a;s++)for(let o=r.y-a;o<=r.y+a;o++)s>=0&&s<e&&o>=0&&o<t&&(d.has(`${s},${o}`)||(n[s+o*e]++,d.set(`${s},${o}`,!0)))}else r.x>=0&&r.x<e&&r.y>=0&&r.y<t&&n[r.x+r.y*e]++}));else if(o.timeStamps[s]>a)break;const u=new Uint32Array(s);return n.forEach(((e,t)=>{e>0&&Atomics.add(u,t,e)})),{playerName:o.playerName,replayHash:o.replayHash,x:h,y:c}}static normalizeHeatmap(e){const t=new Uint32Array(e);let r=1;t.forEach((e=>{e>r&&(r=e)}));const a=new SharedArrayBuffer(8*t.length),s=new Float64Array(a);return t.forEach(((e,t)=>s[t]=k(e,0,r,0,1))),a}};function C(e,t,r,a){const s=[],o=Math.abs(r-e),i=Math.abs(a-t),n=e<r?1:-1,l=t<a?1:-1;let h=o-i;for(;e!==r||t!==a;){s.push({x:e,y:t});let r=2*h;r>-i&&(h-=i,e+=n),r<o&&(h+=o,t+=l)}return s.push({x:r,y:a}),s}function I(e){y.default.parentPort.postMessage(e)}var P=l(require("ffmpeg-static")),D=l(require("fluent-ffmpeg")),T=l(require("path")),F=l(require("fs")),A=(e,t)=>void 0===e?t:e,$=e=>{const t=[];if(e.forEach((e=>{const r=function(e){if(void 0!==e.min&&e.value<e.min)return{error:!0,message:`Value "${e.name}" Is Less Than ${e.min} (Requirement: >= ${e.min}${void 0===e.max?"":` And <= ${e.max}`})`};if(void 0!==e.max&&e.value>e.max)return{error:!0,message:`Value "${e.name}" Is More Than ${e.max} (Requirement: ${void 0===e.min?"":`>= ${e.min} And `}<= ${e.max})`};return{error:!1}}(e);r.error&&t.push(r.message)})),t.length>0)throw new Error(`Values Check Failed (${t.length}):\n${t.map((e=>`| ${e}`)).join("\n")}\n`)};var R=l(require("os"));var B=class{_Core;_textures={};constructor(e){this._Core=e}get textures(){return this._textures}async loadTextures(){const e=[],t=this._Core.options.style;if("image"===this._Core.options.style.cursor.type){const r=(this._Core.options.width+this._Core.options.height)/50*t.cursor.size;for(let a of t.cursor.images)e.push({type:"loadTexture",filePath:a,scaleType:"min",width:r,height:r,effect:{}})}"image"===this._Core.options.style.background.type&&e.push({type:"loadTexture",filePath:t.background.image,scaleType:"max",width:this._Core.options.width,height:this._Core.options.height,effect:{brightness:t.background.brightness}});const r={},a=await this._Core.WorkerManager.createBatch(e);for(let e of a){if(e.error)return{error:!0,message:e.message};r[e.data.filePath]=e.data.texture}return this._textures=r,{error:!1}}unloadTextures(){this._textures={}}},z=l(require("worker_threads")),H=(e,t)=>{let r=O(e);for(;t.includes(r);)r=O(e);return r};function O(e){let t="";for(let s=0;s<e;s++)t+=E[(r=0,a=E.length-1,Math.floor(Math.random()*a)+r)];var r,a;return t}var E="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ123456789",L=class{_workers={};_batches={};_jobs={};async startWorkers(e,t){const r=[];for(let a=0;a<e;a++){const e=H(5,Object.keys(this._workers));this._workers[e]={state:"starting",worker:new z.default.Worker(__filename,{workerData:{type:"HeatTrace",textures:t}})},r.push(this._handleWorker(e))}await Promise.all(r)}async stopWorkers(){for(let e of Object.keys(this._workers))await this._workers[e].worker.terminate(),delete this._workers[e]}async createBatch(e,t){return new Promise((r=>{if(0===e.length)r([]);else{const a={totalJobs:e.length,jobs:{},results:[],progressCallback:t,finishCallback:r};e.forEach((e=>{a.jobs[H(5,Object.keys(a.jobs))]={state:"waiting",data:e}})),this._batches[H(5,Object.keys(this._batches))]=a,void 0!==a.progressCallback&&a.progressCallback({total:a.totalJobs,finished:0}),this._assignJobs()}}))}async createJob(e){return new Promise((t=>{this._jobs[H(5,Object.keys(this._jobs))]={state:"waiting",data:e,callback:t},this._assignJobs()}))}_assignJobs(){for(let e of Object.keys(this._workers)){const t=this._workers[e];if("idle"===t.state){const r=this._getJob();if(void 0===r)break;let a;if(void 0===r.batchID)this._jobs[r.jobID].state="inProgress",a=this._jobs[r.jobID].data;else{const e=this._batches[r.batchID];e.jobs[r.jobID].state="inProgress",a=e.jobs[r.jobID].data}t.state="working",this._sendMessage(e,{type:"assignJob",batchID:r.batchID,jobID:r.jobID,jobData:a})}}}_getJob(){for(let e of Object.keys(this._jobs))if("waiting"===this._jobs[e].state)return{jobID:e};for(let e of Object.keys(this._batches)){const t=this._batches[e];for(let r of Object.keys(t.jobs))if("waiting"===t.jobs[r].state)return{batchID:e,jobID:r}}}_sendMessage(e,t){this._workers[e].worker.postMessage(t)}async _handleWorker(e){return new Promise((t=>{const r=this._workers[e];r.worker.on("message",(e=>{if("readied"===e.type)r.state="idle",t();else if("jobFinished"===e.type){if(void 0===e.batchID){const t=this._jobs[e.jobID];void 0!==t.callback&&t.callback(e.jobResult),delete this._jobs[e.jobID]}else{const t=this._batches[e.batchID];delete t.jobs[e.jobID],t.results.push(e.jobResult),void 0!==t.progressCallback&&t.progressCallback({total:t.totalJobs,finished:t.results.length}),t.results.length>=t.totalJobs&&(t.finishCallback(t.results),delete this._batches[e.batchID])}r.state="idle",this._assignJobs()}}))}))}},W=class{_Core;_cursorsData=[];_frames=0;_frameInterval=0;constructor(e){this._Core=e}get cursorsData(){return this._cursorsData}get frames(){return this._frames}get frameInterval(){return this._frameInterval}async loadReplays(e,t){if("initialized"!==this._Core.state)throw new Error(`Cannot Load Replays: ${this._Core.state}`);const r=e.map((e=>({type:"loadReplay",data:e,maxCursorTravelDistance:this._Core.options.maxCursorTravelDistance}))),a=await this._Core.WorkerManager.createBatch(r,t);let s,o=0,i=0,n=0;const l=[];for(let e of a)if(e.error)n++;else{if(void 0===s)s=e.data.beatmapHash;else if(e.data.beatmapHash!==s)return{error:!0,message:"Found Replays With Different Beatmaps"};const t=e.data.cursorData.timeStamps[e.data.cursorData.timeStamps.length-1];t>o&&(o=t),l.push(e.data.cursorData),i++}return this._cursorsData=l,this._frameInterval=1e3/this._Core.options.videoFPS/this._Core.options.videoSpeed,this._frames=Math.round(o/this._frameInterval),{error:!1,data:{loaded:i,failed:n}}}unloadReplays(){this._cursorsData=[]}},U=async(e,t,r)=>{const a=await async function(e,t,r){if("initialized"!==e.state)throw new Error(`Cannot Calculate The Heatmap: ${e.state}`);const a=new SharedArrayBuffer(e.options.width*e.options.height*4),s=t*e.ReplayManager.frameInterval,o=e.ReplayManager.cursorsData.map((t=>({type:"calculateHeatmap",width:e.options.width,height:e.options.height,start:s-1e3*e.options.style.traceLength,end:s,heatmap:a,cursorData:t,style:e.options.style}))),i=await e.WorkerManager.createBatch(o,r),n=(await e.WorkerManager.createBatch([{type:"normalizeHeatmap",heatmap:a}]))[0].normalizedHeatmap;return{heatmap:n,cursorsInfo:i.map((e=>e.cursorInfo))}}(e,t,(e=>{void 0!==r&&r({type:"calculatingHeatmaps",total:e.total,finished:e.finished})})),s=[{type:"renderLayer",layerData:{type:"heatmap",heatmap:a.heatmap},style:e.options.style}];"none"!==e.options.style.background.type&&s.push({type:"renderLayer",layerData:{type:"background",width:e.options.width,height:e.options.height,textures:e.TextureManager.textures},style:e.options.style}),"none"!==e.options.style.cursor.type&&s.push({type:"renderLayer",layerData:{type:"cursors",width:e.options.width,height:e.options.height,cursors:a.cursorsInfo,textures:e.TextureManager.textures},style:e.options.style});return(await e.WorkerManager.createBatch(s,(e=>{void 0!==r&&r({type:"renderingLayers",total:e.total,finished:e.finished})}))).map((e=>e.layer))};var J=class{_state="none";_options;WorkerManager;TextureManager;ReplayManager;constructor(e){this._options=function(e){const t=A(e.style,{}),r=A(t.cursor,{}),a=A(t.background,{});return{width:Math.round(A(e.width,512)),height:Math.round(A(e.height,384)),style:{heatBoost:A(t.heatBoost,3),traceSize:A(t.traceSize,1),traceOpacity:A(t.traceOpacity,[1,1]),traceLength:A(t.traceLength,1/0),colors:A(t.colors,[{r:0,g:0,b:0},{r:106,g:4,b:15},{r:208,g:0,b:0},{r:232,g:93,b:4},{r:250,g:163,b:7},{r:255,g:255,b:255}]),cursor:{type:A(r.type,"none"),distribution:A(r.distribution,"player"),size:A(r.size,1),opacity:A(r.opacity,1),colors:A(r.colors,[{r:214,g:40,b:40},{r:247,g:127,b:0},{r:252,g:191,b:73},{r:234,g:226,b:183}]),images:A(r.images,[])},background:{type:A(a.type,"none"),brightness:A(a.brightness,1),color:A(a.color,{r:0,g:0,b:0}),image:A(a.image,"")}},imageFormat:A(e.imageFormat,"png"),imageQuality:A(e.imageQuality,1),videoFPS:A(e.videoFPS,30),videoSpeed:A(e.videoSpeed,1),threads:A(e.threads,R.default.cpus().length/2),maxFrameQueue:A(e.maxFrameQueue,1),maxCursorTravelDistance:A(e.maxCursorTravelDistance,200)}}(e),function(e){$([{name:"options.width",value:e.width,min:1},{name:"options.height",value:e.height,min:1},{name:"options.style.traceSize",value:e.style.traceSize,min:0},{name:"options.style.traceOpacity[0]",value:e.style.traceOpacity[0],min:0,max:1},{name:"options.style.traceOpacity[1]",value:e.style.traceOpacity[1],min:0,max:1},{name:"options.style.traceLength",value:e.style.traceLength,min:0},{name:"options.style.cursor.size",value:e.style.cursor.size,min:0},{name:"options.style.cursor.opacity",value:e.style.cursor.opacity,min:0,max:1},{name:"options.style.background.brightness",value:e.style.background.brightness,min:0},{name:"options.imageQuality",value:e.imageQuality,min:.1,max:1},{name:"options.videoFPS",value:e.videoFPS,min:1},{name:"options.videoSpeed",value:e.videoFPS,min:.1},{name:"options.threads",value:e.threads,min:1},{name:"options.maxFrameQueue",value:e.maxFrameQueue,min:1},{name:"options.maxCursorTravelDistance",value:e.maxCursorTravelDistance,min:0}]),e.style.colors.forEach(((e,t)=>{$([{name:`options.style.colors[${t}].r`,value:e.r,min:0,max:255},{name:`options.style.colors[${t}].g`,value:e.g,min:0,max:255},{name:`options.style.colors[${t}].b`,value:e.b,min:0,max:255}])})),e.style.cursor.colors.forEach(((e,t)=>{$([{name:`options.style.cursor.colors[${t}].r`,value:e.r,min:0,max:255},{name:`options.style.cursor.colors[${t}].g`,value:e.g,min:0,max:255},{name:`options.style.cursor.colors[${t}].b`,value:e.b,min:0,max:255}])})),$([{name:"options.style.background.color.r",value:e.style.background.color.r,min:0,max:255},{name:"options.style.background.color.g",value:e.style.background.color.g,min:0,max:255},{name:"options.style.background.color.b",value:e.style.background.color.b,min:0,max:255}])}(this._options),this.WorkerManager=new L,this.TextureManager=new B(this),this.ReplayManager=new W(this)}get state(){return this._state}get options(){return this._options}async initialize(e){if("none"!==this._state)throw new Error(`Cannot Initialize HeatTrace: ${this._state}`);return this._state="initializing",void 0!==e&&e({type:"startingWorkers"}),await this.WorkerManager.startWorkers(this._options.threads,this.TextureManager.textures),void 0!==e&&e({type:"loadingTextures"}),await this.TextureManager.loadTextures(),this._state="initialized",{error:!1}}async terminate(){if("initialized"!==this._state)throw new Error(`Cannot Load Terminate HeatTrace: ${this._state}`);this._state="terminating",await this.WorkerManager.stopWorkers(),this.TextureManager.unloadTextures(),this.ReplayManager.unloadReplays(),this._state="none"}async loadReplays(e,t){if("initialized"!==this._state)throw new Error(`Cannot Load Replays: ${this._state}`);const r=await this.ReplayManager.loadReplays(e,t);return r.error?{error:!0,message:r.message}:{error:!1,data:{loaded:r.data.loaded,failed:r.data.failed}}}async renderImage(e,t){if("initialized"!==this._state)throw new Error(`Cannot Render An Image: ${this._state}`);$([{name:"frame",value:e,min:1,max:this.ReplayManager.frames}]);return new Uint8Array((await this.WorkerManager.createBatch([{type:"renderImage",format:this._options.imageFormat,width:this._options.width,height:this._options.height,layers:await U(this,A(e,this.ReplayManager.frames),t)}],(e=>{void 0!==t&&t({type:"encodingImage",total:e.total,finished:e.finished})})))[0].data)}async renderVideo(e,t,r,a){if("initialized"!==this._state)throw new Error(`Cannot Render An Image: ${this._state}`);return t=A(t,1),r=A(r,this.ReplayManager.frames),$([{name:"start",value:t,min:1,max:r},{name:"end",value:r,min:Math.max(t,1),max:this.ReplayManager.frames}]),new Promise((async s=>{F.default.existsSync(e)||F.default.mkdirSync(e),F.default.existsSync(T.default.join(e,"Frames"))||F.default.mkdirSync(T.default.join(e,"Frames"));let o=t,i=0,n=r-t,l=0;void 0!==a&&a({type:"renderingFrames",total:n,finished:l});const h=async()=>{if(o<=r){let t=o;o++,i++,console.log(t),this.WorkerManager.createJob({type:"renderImage",format:"png",width:this._options.width,height:this._options.height,layers:await U(this,t)}).then((o=>{F.default.writeFileSync(T.default.join(e,"Frames",`${t.toString().padStart(5,"0")}.png`),new Uint8Array(o.data)),i--,l++,void 0!==a&&a({type:"renderingFrames",total:n,finished:l}),t===r?(void 0!==a&&a({type:"encodingVideo",total:1,finished:0}),(0,D.default)(T.default.join(e,"Frames","%05d.png")).setFfmpegPath(P.default).output(T.default.join(e,"Result.mp4")).inputFPS(this._options.videoFPS).outputOptions("-pix_fmt yuv420p").outputOptions(`-threads ${this._options.threads}`).once("end",(()=>{void 0!==a&&a({type:"encodingVideo",total:1,finished:1}),s(T.default.join(e,"Result.mp4"))})).run()):h()})),i<this._options.maxFrameQueue&&h()}};h()}))}},q=class{_Core;constructor(e){this._Core=new J(e||{})}get state(){return this._Core.state}get options(){return this._Core.options}async initialize(e){return await this._Core.initialize(e)}async terminate(){await this._Core.terminate()}async loadReplays(e,t){return await this._Core.loadReplays(e,t)}async renderImage(e,t){return await this._Core.renderImage(e,t)}async renderVideo(e,t,r,a){return await this._Core.renderVideo(e,t,r,a)}};c.default.isMainThread||(y.default.parentPort.on("message",(async e=>{if("assignJob"===e.type){const t=e.jobData;let r;if("loadTexture"===t.type){const e=await _(t.filePath,t.scaleType,t.width,t.height,t.effect);r={type:"loadTexture",error:e.error,message:e.message,data:{filePath:t.filePath,texture:e.texture}}}else if("loadReplay"===t.type){const e=await m(t.data);r="standard"!==e.gameMode?{type:"loadReplay",error:!0,message:"Unsupport Game Mode"}:void 0===e.cursor?{type:"loadReplay",error:!0,message:"Failed To Decompress Cursor Data"}:{type:"loadReplay",error:!1,data:{beatmapHash:e.beatmapHash,cursorData:g(e.playerName,e.replayHash,e.cursor,t.maxCursorTravelDistance)}}}else if("calculateHeatmap"===t.type)r={type:"calculateHeatmap",cursorInfo:S.calculateHeatmap(t.width,t.height,t.start,t.end,t.heatmap,t.cursorData,t.style)};else if("normalizeHeatmap"===t.type)r={type:"normalizeHeatmap",normalizedHeatmap:S.normalizeHeatmap(t.heatmap)};else if("renderLayer"===t.type){const e=t.layerData;"background"===e.type?r={type:"renderLayer",layer:j.renderBackground(e.width,e.height,e.textures,t.style)}:"heatmap"===e.type?r={type:"renderLayer",layer:j.renderHeatmap(e.heatmap,t.style)}:"cursors"===e.type&&(r={type:"renderLayer",layer:j.renderCursors(e.width,e.height,e.cursors,e.textures,t.style)})}else"renderImage"===t.type&&(r={type:"renderImage",data:await j.renderImage(t.format,t.width,t.height,t.layers)});I({type:"jobFinished",batchID:e.batchID,jobID:e.jobID,jobResult:r})}})),I({type:"readied"}));