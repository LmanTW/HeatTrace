"use strict";var t=Object.create,e=Object.defineProperty,s=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyNames,i=Object.getPrototypeOf,r=Object.prototype.hasOwnProperty,n=(n,o,h)=>(h=null!=n?t(i(n)):{},((t,i,n,o)=>{if(i&&"object"==typeof i||"function"==typeof i)for(let h of a(i))r.call(t,h)||h===n||e(t,h,{get:()=>i[h],enumerable:!(o=s(i,h))||o.enumerable});return t})(!o&&n&&n.__esModule?h:e(h,"default",{value:n,enumerable:!0}),n)),o=n(require("worker_threads")),h=n(require("worker_threads")),l=(t,e,s,a,i)=>(t-e)/(s-e)*(i-a)+a,d=(t,e,s,a,i,r)=>{const n=new Map;function o(t,e){const s=`${t},${e}`;n.has(s)?n.set(s,n.get(s)+1):n.set(s,1)}i.timeStamps.forEach(((n,h)=>{h>0&&n>=s&&n<=a&&function(t,e,s,a){const i=[],r=Math.abs(s-t),n=Math.abs(a-e),o=t<s?1:-1,h=e<a?1:-1;let l=r-n;for(;t!==s||e!==a;){i.push({x:t,y:e});let s=2*l;s>-n&&(l-=n,t+=o),s<r&&(l+=r,e+=h)}return i.push({x:s,y:a}),i}(Math.round(l(i.xPositions[h-1],0,512,0,t)),Math.round(l(i.yPositions[h-1],0,384,0,e)),Math.round(l(i.xPositions[h],0,512,0,t)),Math.round(l(i.yPositions[h],0,384,0,e))).forEach((t=>{if(r>1)for(let e=t.x-r;e<t.x+r;e++)for(let s=t.y-r;s<t.y+r;s++)o(e,s);else o(t.x,t.y)}))}));const h=new Uint32Array(3*n.size);return n.forEach(((t,e)=>{const s=e.split(","),a=parseInt(s[0]),i=parseInt(s[1]);h[0]=a,h[1]=i,h[2]=t})),h};var c=require("lzma-native"),u=class{_data="";_index=0;constructor(t){t.forEach((t=>this._data+=t.toString(2).padStart(8,"0")))}readByte(){return parseInt(this._read(8),2)}readShort(){return g([this._read(8),this._read(8)],8)}readInteger(){return g([this._read(8),this._read(8),this._read(8),this._read(8)],8)}readLong(){return g([this._read(8),this._read(8),this._read(8),this._read(8),this._read(8),this._read(8),this._read(8),this._read(8)],8)}readULEB128(){const t=[];for(;;){const e=this._read(8);if(t.push(e.substring(1,8)),"0"===e[0])break}return g(t,7)}readString(){if(11===this.readByte()){const t=this.readULEB128();let e=[];for(let s=0;s<t;s++)e.push(parseInt(this._read(8),2));return Buffer.from(e).toString("utf8")}return""}_read(t){const e=this._data.substring(this._index,this._index+t);return this._index+=t,e}};function g(t,e){let s=0,a=0;for(let i=0;i<t.length;i++){s|=(parseInt(t[i],2)&(1<<e)-1)<<a,a+=e}return s}var _={},p=n(require("path")),f=n(require("os")),y=n(require("fs")),m=n(require("os")),w={resolution:"1024x768",fps:30,threads:Math.round(m.default.cpus().length/2)},b={},P=(t,e)=>Math.floor(Math.random()*e)+t,v=(t,e,s)=>{let a=k(t,s||"both");for(;e.includes(a);)a=k(t,s||"both");return a};function k(t,e){let s="";for(let a=0;a<t;a++)s+="number"===e?$[P(0,$.length-1)]:"alphabet"===e?S[P(0,S.length-1)]:x[P(0,x.length-1)];return s}var $="1234567890",S="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",x="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890",j=class{_interval=void 0;_timers={};createTimeout(t,e){const s=v(5,Object.keys(this._timers));return this._timers[s]={times:1,interval:t,callback2:e,count:0,lastUpdateTime:performance.now()},void 0===this._interval&&this._start(),s}createInterval(t,e){const s=v(5,Object.keys(this._timers));return this._timers[s]={times:1/0,interval:t,callback:e,count:0,lastUpdateTime:performance.now()},void 0===this._interval&&this._start(),s}createLoop(t,e,s,a){const i=v(5,Object.keys(this._timers));return this._timers[i]={times:t,interval:e,callback:s,callback2:a,count:0,lastUpdateTime:performance.now()},void 0===this._interval&&this._start(),i}deleteTimer(t){if(void 0===this._timers[t])throw new Error(`Timer Not Found: "${t}"`);delete this._timers[t],0===Object.keys(this._timers).length&&(clearInterval(this._interval),this._interval=void 0)}deleteAllTimers(){Object.keys(this._timers).forEach((t=>this.deleteTimer(t)))}_start(){this._interval=setInterval((()=>{const t=performance.now();Object.keys(this._timers).forEach((e=>{const s=this._timers[e];void 0!==s&&t-s.lastUpdateTime>=s.interval&&(void 0!==s.callback&&s.callback(s.count),s.lastUpdateTime=t,s.times!==1/0&&(s.count++,s.count===s.times&&(void 0!==s.callback2&&s.callback2(),delete this._timers[e])))}))}),1)}},A=class{_currentPage=void 0;_pages={};PageInstance;constructor(t){this.PageInstance=new M(t)}get currentPage(){return this._currentPage}addPage(t){if(void 0!==this._pages[t.id])throw new Error(`Page Alreadt Added: "${t.id}"`);return this._pages[t.id]={initialize:t.initialize,components:[]},void 0!==t.subPages&&t.subPages.forEach((t=>this.addPage(t))),this}async switchPage(t){if(void 0===this._pages[t])throw new Error(`Page Not Found: "${t}"`);this.PageInstance.TimerManager.deleteAllTimers(),this._pages[t].components=await this._pages[t].initialize(this.PageInstance),this._currentPage=t}render(t,e){const s=[];for(let a=0;a<e;a++)s.push(" ".repeat(t));return void 0===this._currentPage||this._pages[this._currentPage].components.forEach((a=>a.render(t,e,s))),s}keydown(t){void 0!==this._currentPage&&this._pages[this._currentPage].components.forEach((e=>e.keydown(t)))}},M=class{Core;TimerManager=new j;constructor(t){this.Core=t}},I=n(require("readline")),T=n(require("stream")),C=n(require("wcwidth")),D=class{_options;_layout=[E.pageTabs(),E.blank(),E.pageContent(),E.blank(),E.input()];_style={background:R.reset,background_notSelected:R.gray,text_notSelected:O.white,background_selected:R.white,text_selected:O.gray};interval;interface;_size={width:void 0,height:void 0};_pages={};_data={input:"",currentPage:void 0};_listeners={};_oldRenderContent=[];constructor(t){if(void 0===t&&(t={}),this._options=t,(void 0===t.render||t.render)&&(process.stdout.write(`[?25l${"\n".repeat(process.stdout.rows)}`),this.interval=setInterval((()=>process.stdout.write(this.render().map((t=>`[H${t.line>0?`[${t.line}B`:""}[2K${t.content}`)).join(""))),t.renderInterval||25)),void 0===t.allowInput||t.allowInput){const t=new T.default.Writable({write:()=>{}});this.interface=I.default.createInterface({input:process.stdin,output:t,terminal:!0,historySize:0}),process.stdin.on("data",(t=>this._handleInput(t)))}}get options(){return this._options}get size(){return this._getSize()}get pages(){return Object.keys(this._pages)}get input(){return this._data.input}get currentPage(){return this._data.currentPage}get cursorY(){const t=this._pages[this._data.currentPage];void 0!==t&&t.cursorY}stop(){if(void 0===this.interval)throw new Error("Cannot Stop The CLI");clearInterval(this.interval),void 0!==this.interface&&(this.interface.close(),process.stdin.off("data",this._handleInput),this.interface=void 0),this.interval=void 0,process.stdout.write("[?25h")}setSize(t,e){return this._size={width:t,height:e},this}setLayout(t){return this._layout=t,this}setStyle(t){return this._style=t,this}createPage(t,e,s){if(void 0!==this._pages[t])throw new Error(`Page Already Exist: "${t}"`);return this._pages[t]={name:e,callback:s,content:[],cursorY:0,scrollY:0},void 0===this._data.currentPage&&(this._data.currentPage=t,this._oldRenderContent=[]),this}deletePage(t){if(void 0===this._pages[t])throw new Error(`Page Not Found: "${t}"`);if(void 0!==this._data.currentPage){const e=Object.keys(this._pages).indexOf(this._data.currentPage);delete this._pages[t];const s=Object.keys(this._pages);0===s.length?this._data.currentPage=void 0:e>=s.length&&(this._data.currentPage=s[s.length-1]),this._oldRenderContent=[]}else delete this._pages[t]}setInput(t){this._data.input=t}simulateInput(t){this._handleInput(t)}switchPage(t){if(void 0===this._pages[t])throw new Error(`Page Not Found: "${t}"`);this._data.currentPage=t}listen(t,e){const s=function(t,e){let s=z(t);for(;e.includes(s);)s=z(t);return s}(5,Object.keys(this._listeners));return this._listeners[s]={type:t,callback:e},s}removeListener(t){if(void 0===this._listeners[t])throw new Error(`Listener Not Found: "${t}"`);delete this._listeners[t]}removeAllListeners(){this._listeners={}}render(){let t=[];this._layout.forEach((e=>t=t.concat(this._renderComponent(e))));const e=this._getSize();for(;t.length<e.height-1;)t.push("");const s=[];return this._oldRenderContent=t.slice(0,e.height-1).map(((t,a)=>{let i=this._sperateColor(t.replaceAll("\n","\\n")),r=i.map((t=>t.text)).join("");if((0,C.default)(r)<e.width)i.push({sequence:this._style.background,text:" ".repeat(e.width-(0,C.default)(r))});else for(;(0,C.default)(r)>e.width;)i=i.slice(0,i.length-1),r=r.substring(0,r.length-1);const n=`${this._style.background}${i.map((t=>`${void 0===t.sequence?"":t.sequence}${t.text}`)).join("")}`;return n!==this._oldRenderContent[a]&&s.push({line:a,content:n}),n})),s}_renderComponent(t){if("blank"===t.type)return[this._style.background];if("text"===t.type)return[t.callback()];if("pageTabs"===t.type){const t=[];return Object.keys(this._pages).forEach((e=>{e===this._data.currentPage?t.push(`${this._style.background_selected} ${this._style.text_selected}${this._pages[e].name} ${this._style.background}`):t.push(`${this._style.background_notSelected} ${this._style.text_notSelected}${this._pages[e].name} ${this._style.background}`)})),[` ${t.join(" ")} `]}if("pageContent"===t.type){const t=this._getSize(),e=[];if(void 0!==this._data.currentPage){const s=this._pages[this._data.currentPage];s.content=s.callback();const a=void 0===this._options.pagePrefix_notSelected?" <lineNumber> | ":this._options.pagePrefix_notSelected,i=void 0===this._options.pagePrefix_selected?`${this._style.background_selected} ${this._style.text_selected}<lineNumber>${O.reset}${this._style.background} | `:this._options.pagePrefix_selected;for(let r=s.scrollY;r<s.scrollY+(t.height-this._layout.length)&&r<s.content.length;r++){const t=(r+1).toString().padStart(2," ");s.cursorY===r?e.push(`${i.replaceAll("<lineNumber>",t)}${s.content[r]}`):e.push(`${a.replaceAll("<lineNumber>",t)}${s.content[r]}`)}}for(;e.length<t.height-this._layout.length;)e.push("");return e}if("input"===t.type){const e=this._getSize();let s=` ${this._data.input.length>0?`${this._style.background_selected}${this._style.text_selected}`:`${this._style.background_notSelected}${this._style.text_notSelected}`} `;return this._data.input.length>0?s+=this._data.input:s+=t.placeholder||"⇧⇩ Scroll | ⇦⇨ Switch Page | Type to give input",s+=" ".repeat(e.width-(0,C.default)(this._sperateColor(s).map((t=>t.text)).join("")+" "))+this._style.background,[s]}return[]}_getSize(){return{width:this._size.width||process.stdout.columns,height:this._size.height||process.stdout.rows}}_sperateColor(t){const e=[];let s="";for(let a=0;a<t.length;a++)if(""===t[a]){const e=a;for(;"m"!==t[a]&&a<t.length;)s+=t[a],a++;"m"===t[a]?s+="m":a=e}else void 0===s?e.push({text:t[a]}):(e.push({sequence:s,text:t[a]}),s="");return e}_handleInput(t){const e=t.toString("hex");if([...q.upArrow,...q.downArrow,...q.leftArrow,...q.rightArrow].includes(e)){if(void 0!==this._data.currentPage){const t=this._pages[this._data.currentPage];if(!q.upArrow.includes(e)||void 0!==this._options.allowScroll&&!0!==this._options.allowScroll)if(!q.downArrow.includes(e)||void 0!==this._options.allowScroll&&!0!==this._options.allowScroll)if(!q.leftArrow.includes(e)||void 0!==this._options.allowSwitchPage&&!0!==this._options.allowSwitchPage){if(q.rightArrow.includes(e)&&(void 0===this._options.allowSwitchPage||!0===this._options.allowSwitchPage)){const t=Object.keys(this._pages);t.indexOf(this._data.currentPage)>t.length-2?this._data.currentPage=t[0]:this._data.currentPage=t[t.indexOf(this._data.currentPage)+1],this._callEvent("switchPage",this._data.currentPage)}}else{const t=Object.keys(this._pages);t.indexOf(this._data.currentPage)<1?this._data.currentPage=t[t.length-1]:this._data.currentPage=t[t.indexOf(this._data.currentPage)-1],this._callEvent("switchPage",this._data.currentPage)}else{const e=this._getSize();t.cursorY-t.scrollY<e.height-this._layout.length-1&&t.cursorY<t.content.length-1?t.cursorY++:t.cursorY<t.content.length-1&&(t.cursorY++,t.scrollY++),this._callEvent("scroll",{page:this._data.currentPage,cursorY:t.cursorY,scrollY:t.scrollY})}else t.cursorY>t.scrollY?t.cursorY--:t.scrollY>0&&(t.cursorY--,t.scrollY--),this._callEvent("scroll",{page:this._data.currentPage,cursorY:t.cursorY,scrollY:t.scrollY})}}else if(q.enter.includes(e))this._data.input.length>0?(this._callEvent("enter",this._data.input),this._data.input=""):void 0!==this._data.currentPage&&this._callEvent("select",{page:this._data.currentPage,cursorY:this._pages[this._data.currentPage].cursorY});else if(q.backspace.includes(e))this._data.input.length>0&&(this._data.input=this._data.input.substring(0,this._data.input.length-1)),this._callEvent("input",this._data.input);else{/^[a-zA-Z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/? ]*$/.test(t.toString())&&(this._data.input+=t.toString()),this._callEvent("input",t)}this._callEvent("keydown",t)}_callEvent(t,e){Object.keys(this._listeners).forEach((s=>{this._listeners[s].type===t&&this._listeners[s].callback(e)}))}},E=class{static blank(){return{type:"blank"}}static text(t){return{type:"text",callback:t}}static pageTabs(){return{type:"pageTabs"}}static pageContent(){return{type:"pageContent"}}static input(t){return{type:"input",placeholder:t}}};function z(t){let e="";for(let i=0;i<t;i++)e+=Y[(s=0,a=Y.length-1,Math.floor(Math.random()*a)+s)];var s,a;return e}var O={reset:"[0m",red:"[31m",brightRed:"[92m",yellow:"[33m",brightYellow:"[93m",green:"[32m",brightGreen:"[92m",cyan:"[36m",brightCyan:"[96m",blue:"[34m",brightBlue:"[94m",purple:"[35m",brightPurple:"[95m",white:"[97m",black:"[30m",gray:"[90m"},R={reset:"[0m",red:"[41m",brightRed:"[101m",yellow:"[43m",brightYellow:"[103m",green:"[42m",brightGreen:"[102m",cyan:"[46m",brightCyan:"[106m",blue:"[44m",brightBlue:"[104m",purple:"[104m",brightPurple:"[105m",white:"[107m",black:"[40m",gray:"[100m"},q={upArrow:["1b5b41"],downArrow:["1b5b42"],leftArrow:["1b5b44"],rightArrow:["1b5b43"],enter:["0d"],backspace:["7f","08"]},Y="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ123456789",H=n(require("wcwidth")),F=class{static bold(t){return`[1m${t}[22m`}static underline(t){return`[4m${t}[24m`}static strikethrough(t){return`[9m${t}[29m`}static red(t){return`[31m${t}[0m`}static yellow(t){return`[33m${t}[0m`}static green(t){return`[32m${t}[0m`}static cyan(t){return`[36m${t}[0m`}static blue(t){return`[34m${t}[0m`}static purple(t){return`[35m${t}[0m`}static brightRed(t){return`[91m${t}[0m`}static brightYellow(t){return`[93m${t}[0m`}static brightGreen(t){return`[92m${t}[0m`}static brightCyan(t){return`[96m${t}[0m`}static brightBlue(t){return`[94m${t}[0m`}static brightPurple(t){return`[95m${t}[0m`}static white(t){return`[37m${t}[0m`}static black(t){return`[30m${t}[0m`}static gray(t){return`[30m${t}[0m`}};function B(t){let e="";for(let s=0;s<t.length;s++)if(""===t[s]){const e=s;for(;"m"!==t[s]&&s<t.length;)s++;"m"!==t[s]&&(s=e)}else e+=t[s];return(0,H.default)(e)}function L(t,e,s,a){const i=B(s);if(a+i>t){const e=a+i-t;for(;B(s)>e&&s.length>0;)s=s.substring(0,s.length-1)}else if(a<0){const t=i+a;for(;B(s)>t&&s.length>0;)s=s.substring(1,s.length);a=0}let r="",n="";for(let t=0;B(r)<a&&t<e.length;t++)r+=e[t];for(let i=e.length-1;(0,H.default)(n)<t-(a+B(s))&&i>=0;i--)n+=e[i];return r+s+n}var U=class{},N=class extends U{_options;_selected=0;_x;_y;_width;_height;_style;constructor(t,e,s,a){if(super(),0===t.length)throw new Error("No Options Provided");this._options=t,this._x=e,this._y=s,this._style=a||{},this._measure()}setOptions(t){if(0===t.length)throw new Error("No Options Provided");this._options=t}render(t,e,s){let a,i;"left"===this._style.horizontalAlign||void 0===this._style.horizontalAlign?a=Math.round(this._x):"center"===this._style.horizontalAlign?a=Math.round(t/2-this._width/2)+this._x:"right"===this._style.horizontalAlign&&(a=Math.round(t-this._width)+this._x),"top"===this._style.verticalAlign||void 0===this._style.verticalAlign?i=Math.round(this._y):"center"===this._style.verticalAlign?i=Math.round(e/2-this._height/2)+this._y:"bottom"===this._style.verticalAlign&&(i=Math.round(e-this._height)+this._y);const r=void 0===this._style.prefix_notSelected?"":this._style.prefix_notSelected,n=void 0===this._style.suffix_notSelected?"":this._style.suffix_notSelected,o=void 0===this._style.prefix_selected?"> ":this._style.prefix_selected,h=void 0===this._style.suffix_selected?" <":this._style.suffix_selected;this._options.forEach(((l,d)=>{let c=Math.round(i+d);if(c>=0&&c<e){let e,i=d===this._selected?`${o}${l.name(!0)}${h}`:`${r}${l.name(!1)}${n}`,u=this._style.optionAlign||l.optionAlign;"left"===u||void 0===u?e=a:"center"===u?e=a+Math.round(this._width/2-B(i)/2):"right"===u&&(e=a+Math.round(this._width/2-B(i))),s[c]=L(t,s[c],i,e)}}))}keydown(t){const e=t.toString("hex");"1b5b41"===e?(this._selected--,this._selected<0&&(this._style.loop?this._selected=this._options.length-1:this._selected=0)):"1b5b42"===e?(this._selected++,this._selected>=this._options.length&&(this._style.loop?this._selected=0:this._selected=this._options.length-1)):void 0!==this._options[this._selected].selected&&("0d"===e?this._options[this._selected].selected("none"):"1b5b44"===e?this._options[this._selected].selected("left"):"1b5b43"===e&&this._options[this._selected].selected("right")),this._measure()}_measure(){let t=0;const e=void 0===this._style.prefix_selected?"> ":this._style.prefix_selected,s=void 0===this._style.suffix_selected?" <":this._style.suffix_selected;this._options.forEach(((a,i)=>{const r=B(`${e}${a.name(i===this._selected)}${s}`);r>t&&(t=r)})),this._width=t,this._height=this._options.length}},J=["⠙","⠸","⢰","⣠","⣄","⡆","⠇","⠋"],W=class{_Core;_state="idle";_cli=void 0;constructor(t){this._Core=t}start(){if("idle"!==this._state)throw new Error(`Cannot Start The User Interface: ${this._state}`);this._state="rendering",this._cli=new D({renderInterval:25,pagePrefix_notSelected:"",pagePrefix_selected:"",allowScroll:!1,allowSwitchPage:!1}),this._cli.setLayout([{type:"pageContent"}]).createPage("page","page",(()=>void 0===this._Core.PageManager.currentPage?[]:this._Core.PageManager.render(process.stdout.columns,process.stdout.rows))).listen("keydown",(t=>this._Core.PageManager.keydown(t)))}stop(){if("rendering"!==this._state)throw new Error(`Cannot Stop The User Interface: ${this._state}`);this._state="idle",this._cli.stop()}},G={SelectMenu:N,Tasks:class extends U{_tasks;_x;_y;_width;_height;_style;constructor(t,e,s,a){if(super(),0===t.length)throw new Error("No Tasks Provided");this._tasks=t,this._x=e,this._y=s,this._style=a||{},this._measure()}setTask(t,e,s){this._tasks.forEach((a=>{a.id===t&&(void 0!==e&&(a.state=e),void 0!==s&&(a.name=s,this._measure()))}))}render(t,e,s){let a,i;"left"===this._style.horizontalAlign||void 0===this._style.horizontalAlign?a=Math.round(this._x):"center"===this._style.horizontalAlign?a=Math.round(t/2-this._width/2)+this._x:"right"===this._style.horizontalAlign&&(a=Math.round(t-this._width)+this._x),"top"===this._style.verticalAlign||void 0===this._style.verticalAlign?i=Math.round(this._y):"center"===this._style.verticalAlign?i=Math.round(e/2-this._height/2)+this._y:"bottom"===this._style.verticalAlign&&(i=Math.round(e-this._height)+this._y),this._tasks.forEach(((r,n)=>{const o=Math.round(i+n);if(o>=0&&o<e){let e,i;"waiting"===r.state?i=`◇ ${r.name}`:"inProgress"===r.state?i=F.yellow(`${J[Math.round(performance.now()/100%(J.length-1))]} ${r.name}`):"finished"===r.state&&(i=F.green(`✓ ${r.name}`)),"left"===this._style.taskAlign||void 0===this._style.taskAlign?e=a:"center"===this._style.taskAlign?e=a+Math.round(this._width/2-B(i)/2):"right"===this._style.taskAlign&&(e=a+Math.round(this._width/2-B(i))),s[o]=L(t,s[o],i,e)}}))}keydown(){}_measure(){let t=0;this._tasks.forEach(((e,s)=>{const a=B(e.name.split("\n")[0])+1;a>t&&(t=a)})),this._width=t,this._height=this._tasks.length}},Text:class extends U{_content;_x;_y;_width;_height;_style;constructor(t,e,s,a){super(),this._content=t,this._x=e,this._y=s,this._style=a||{},this._measure()}setContent(t){this._content=t,this._measure()}render(t,e,s){let a,i;"left"===this._style.horizontalAlign||void 0===this._style.horizontalAlign?a=Math.round(this._x):"center"===this._style.horizontalAlign?a=Math.round(t/2-this._width/2)+this._x:"right"===this._style.horizontalAlign&&(a=Math.round(t-this._width)+this._x),"top"===this._style.verticalAlign||void 0===this._style.verticalAlign?i=Math.round(this._y):"center"===this._style.verticalAlign?i=Math.round(e/2-this._height/2)+this._y:"bottom"===this._style.verticalAlign&&(i=Math.round(e-this._height)+this._y),this._content.split("\n").forEach(((r,n)=>{const o=Math.round(i+n);o>=0&&o<=e&&(s[o]=L(t,s[o],r,a))}))}keydown(){}_measure(){let t=0;const e=this._content.split("\n");e.forEach((e=>{const s=B(e);s>t&&(t=s)})),this._width=t,this._height=e.length}}},K=n(require("path")),V=n(require("fs")),Z=n(require("worker_threads")),Q=class{_workers={};_requests={};_batches={};async startWorkers(t){const e=[];for(let s=0;s<t;s++){const t=v(5,Object.keys(this._workers));this._workers[t]={state:"starting",worker:new Z.default.Worker(__filename,{workerData:{HeatTrace:!0}})},e.push(this._handleWorker(t))}await Promise.all(e)}stopWorkers(){Object.keys(this._workers).forEach((t=>{this._workers[t].worker.terminate(),delete this._workers[t]}))}async addBatch(t,e,s){return new Promise((a=>{const i={type:t,totalJobs:e.length,jobs:{},result:[],progressCallback:s,finishCallback:a};e.forEach((t=>i.jobs[v(5,Object.keys(i.jobs))]={state:"waiting",data:t})),this._batches[v(5,Object.keys(this._batches))]=i,this._assignJobs()}))}async sendRequest(t,e){if(void 0===this._workers[t])throw new Error(`Worker Not Found: "${t}"`);return new Promise((s=>{const a=v(5,Object.keys(this._requests));this._requests[a]=s,this._workers[t].worker.postMessage({type:"request",data:e,requestID:a})}))}_assignJobs(){for(let t of Object.keys(this._workers))if("readied"===this._workers[t].state){const e=this._getJob();if(void 0===e)break;this._workers[t].state="working",this._batches[e.batchID].jobs[e.jobID].state="inProgress",this._workers[t].worker.postMessage({type:"assignJob",batchID:e.batchID,batchType:this._batches[e.batchID].type,jobID:e.jobID,data:this._batches[e.batchID].jobs[e.jobID].data})}}_getJob(){for(let t of Object.keys(this._batches)){const e=this._batches[t];for(let s of Object.keys(e.jobs))if("waiting"===e.jobs[s].state)return{batchID:t,jobID:s};break}}async _finishBatch(t){const e=[];await Promise.all(Object.keys(this._workers).map((async s=>{const a=await this.sendRequest(s,{type:"finishBatch",batchID:t});void 0!==a&&a.forEach((t=>e.push(t)))}))),this._batches[t].finishCallback(e),delete this._batches[t]}async _handleWorker(t){return new Promise((e=>{const s=this._workers[t];s.worker.on("message",(t=>{if("ready"===t.type)s.state="readied",e();else if("response"===t.type)this._requests[t.requestID](t.data),delete this._requests[t.requestID];else if("jobFinished"===t.type){s.state="readied";const e=this._batches[t.batchID];delete e.jobs[t.jobID],void 0!==e.progressCallback&&e.progressCallback({total:e.totalJobs,finished:e.totalJobs-Object.keys(e.jobs).length}),0===Object.keys(e.jobs).length&&this._finishBatch(t.batchID),this._assignJobs()}}))}))}},X=class{_state="idle";_options;_replays=[];WorkerManager;constructor(t){this._options=t,this.WorkerManager=new Q}async initialize(){if("idle"!==this._state)throw new Error(`Cannot Initialize HeatTrace: ${this._state}`);this._state="initializing",await this.WorkerManager.startWorkers(this._options.threads),this._state="initialized"}async loadReplays(t,e){if("initialized"!==this._state)throw new Error(`Cannot Load Replays: ${this._state}`);const s=await this.WorkerManager.addBatch("loadReplays",t,(t=>{void 0!==e&&e({total:t.total,loaded:t.finished})})),a=[];let i,r;for(let t of s)if(!t.error){if(void 0===i)i=t.data.beatmapHash;else if(t.data.beatmapHash!==i)return{error:!0,message:"Found Replays With Different Beatmaps"};(void 0===r||t.data.timeStamps[t.data.timeStamps.length-1]>r)&&(r=t.data.timeStamps[t.data.timeStamps.length-1]),a.push({xPositions:t.data.xPositions,yPositions:t.data.yPositions,timeStamps:t.data.timeStamps})}return{error:!1,data:a,beatmapLength:r}}async calculateHeatmap(t,e,s,a){if("initialized"!==this._state)throw new Error(`Cannot Calculate The Heatmap: ${this._state}`);const i=[];t.forEach((t=>i.push({width:this._options.width,height:this._options.height,start:e,end:s,replay:t})));const r=await this.WorkerManager.addBatch("calculateHeatmap",i,(t=>{void 0!==a&&a(t)}));return(await this.WorkerManager.addBatch("combineHeatmaps",[{width:this._options.width,height:this._options.height,heatmaps:r}]))[0]}},tt={id:"rendering_image",initialize:async t=>{let e=new G.Tasks([{id:"prepareThreads",state:"inProgress",name:"Preparing Threads"},{id:"loadReplays",state:"waiting",name:"Load Replays"},{id:"calculateHeatmap",state:"waiting",name:"Calculate Heatmap"},{id:"renderImage",state:"waiting",name:"Render Image"}],0,0,{horizontalAlign:"center",verticalAlign:"center"});const s=t.Core.settings,a=new X({width:+s.resolution.split("x")[0],height:+s.resolution.split("x")[1],fps:s.fps,threads:s.threads});return a.initialize().then((async()=>{e.setTask("prepareThreads","finished","Threads Prepared"),e.setTask("loadReplays","inProgress","Loading Replays 0% (0 / 0)");const s=[];V.default.readdirSync(K.default.join(t.Core.dataPath,"Replays")).forEach((e=>{".osr"===K.default.extname(e)&&s.push(V.default.readFileSync(K.default.join(t.Core.dataPath,"Replays",e)))}));const i=await a.loadReplays(s,(t=>e.setTask("loadReplays","inProgress",`Loading Replays ${Math.round(100/t.total*t.loaded)}% (${t.loaded} / ${t.total})`)));i.error||(e.setTask("loadReplays","finished",`Replays Loaded (${F.red("Failed: "+(s.length-i.data.length))})`),e.setTask("calculateHeatmap","inProgress","Calculating Heatmap 0% (0 / 0)"),await a.calculateHeatmap(i.data,0,i.beatmapLength,(t=>e.setTask("calculateHeatmap","inProgress",`Calculating Heatmap ${Math.round(100/t.total*t.finished)}% (${t.finished} / ${t.total})`))),e.setTask("calculateHeatmap","finished","Heatmap Calculated"),e.setTask("renderImage","inProgress","Rendering Image"))})),[e]}},et=n(require("os")),st={id:"settings",initialize:async t=>{t.Core.loadData();const e=t.Core.settings,s=["512x384","1024x768","2048x1536","4096x3072"],a=[15,30,60,120],i=et.default.cpus().length;return[new G.Text(F.bold("- Settings -"),0,1,{horizontalAlign:"center"}),new G.SelectMenu([{name:()=>"512x384"===e.resolution?`Resolution: ${F.yellow("512x384 (Low)")}`:"1024x768"===e.resolution?`Resolution: ${F.green("1024x768 (Medium)")}`:"2048x1536"===e.resolution?`Resolution: ${F.blue("2048x1536 (High)")}`:`Resolution: ${F.cyan("4096x3072 (Ultra)")}`,selected:t=>{let a=s.indexOf(e.resolution);"left"===t?(a--,a<0&&(a=0)):"right"===t&&(a++,a>=s.length&&(a=s.length-1)),e.resolution=s[a]}},{name:()=>15===e.fps?`FPS: ${F.yellow("30 (Low)")}`:30===e.fps?`FPS: ${F.green("30 (Medium)")}`:60===e.fps?`FPS: ${F.blue("60 (High)")}`:`FPS: ${F.cyan("120 (Ultra)")}`,selected:t=>{let s=a.indexOf(e.fps);"left"===t?(s--,s<0&&(s=0)):"right"===t&&(s++,s>=a.length&&(s=a.length-1)),e.fps=a[s]}},{name:()=>""},{name:()=>e.threads>=32?`Threads: ${F.purple(`${e.threads} / ${i} (Mega Super Ultra)`)}`:e.threads>=32?`Threads: ${F.purple(`${e.threads} / ${i} (Super Ultra)`)}`:e.threads>=16?`Threads: ${F.cyan(`${e.threads} / ${i} (Ultra)`)}`:e.threads>=8?`Threads: ${F.blue(`${e.threads} / ${i} (High)`)}`:e.threads>=4?`Threads: ${F.green(`${e.threads} / ${i} (Medium)`)}`:e.threads>=2?`Threads: ${F.yellow(`${e.threads} / ${i} (Low)`)}`:`Threads: ${F.red(`${e.threads} / ${i} (Potato)`)}`,selected:t=>{"left"===t?(e.threads--,e.threads<1&&(e.threads=1)):(e.threads++,e.threads>i&&(e.threads=i))}},{name:()=>""},{name:()=>"Back",selected:()=>{t.Core.saveData(),t.Core.PageManager.switchPage("home")},optionAlign:"center"}],0,3,{horizontalAlign:"center"}),new G.Text(F.green("Press [Left / Right] to change."),0,-1,{horizontalAlign:"center",verticalAlign:"bottom"})]}},at={id:"recover",initialize:async t=>[new G.Text(F.bold("- Recover -"),0,-2,{horizontalAlign:"center",verticalAlign:"center"}),new G.Text("Found an unfinished project, do you want to recover it to continue rendering?",0,-1,{horizontalAlign:"center",verticalAlign:"center"}),new G.SelectMenu([{name:()=>"Recover"},{name:()=>"Back",selected:()=>{t.Core.PageManager.switchPage("home")}}],0,1,{horizontalAlign:"center",verticalAlign:"center"})]},it=n(require("path")),rt={id:"render",initialize:async t=>{let e="image";return[new G.Text(F.bold("- Render -"),0,-2,{horizontalAlign:"center",verticalAlign:"center"}),new G.Text(`Put your replays in: ${F.green(it.default.join(t.Core.dataPath,"Data","Replays"))}`,0,0,{horizontalAlign:"center",verticalAlign:"center"}),new G.SelectMenu([{name:()=>"image"===e?`Render: ${F.purple("Image")}`:`Render: ${F.purple("Video")}`,selected:s=>{"none"===s?t.Core.PageManager.switchPage("image"===e?"rendering_image":"rendering_video"):e="image"===e?"video":"image"}},{name:()=>"Back",selected:()=>t.Core.PageManager.switchPage("home")}],0,2,{horizontalAlign:"center",verticalAlign:"center",optionAlign:"center"}),new G.Text(F.green("Press [Left / Right] to change."),0,-1,{horizontalAlign:"center",verticalAlign:"bottom"})]}},nt={id:"home",initialize:async t=>[new G.Text(F.bold(F.yellow("- Heat Trace -")),0,-2,{horizontalAlign:"center",verticalAlign:"center"}),new G.SelectMenu([{name:()=>"Render",selected:()=>t.Core.PageManager.switchPage("render")},{name:()=>"Settings",selected:()=>t.Core.PageManager.switchPage("settings")},{name:()=>"Exit",selected:()=>t.Core.stop()}],0,1,{horizontalAlign:"center",verticalAlign:"center",optionAlign:"center"}),new G.Text(F.green("Press [Enter] to select, [Up / Down] to move."),0,-1,{horizontalAlign:"center",verticalAlign:"bottom"})]},ot=class{_dataPath=p.default.join(f.default.homedir(),"HeatTrace");_state="idle";UserInterface;PageManager;settings;projectData;constructor(){this.UserInterface=new W(this),this.PageManager=new A(this),this.loadData(),this.PageManager.addPage(tt).addPage(st).addPage(at).addPage(rt).addPage(nt)}get dataPath(){return this._dataPath}get state(){return this._state}start(){if("idle"!==this._state)throw new Error(`Cannot Start The APP: ${this._state}`);this._state="running",this.PageManager.switchPage("home"),this.UserInterface.start()}stop(){if("running"!==this._state)throw new Error(`Cannot Stop The APP: ${this._state}`);this._state="idle",this.UserInterface.stop()}loadData(){this.check(),this.settings=JSON.parse(y.default.readFileSync(p.default.join(this._dataPath,"Data","Settings.json"),"utf8")),this.projectData=JSON.parse(y.default.readFileSync(p.default.join(this._dataPath,"Data","ProjectData.json"),"utf8"))}saveData(){this.check(),y.default.writeFileSync(p.default.join(this._dataPath,"Data","Settings.json"),JSON.stringify(this.settings)),y.default.writeFileSync(p.default.join(this._dataPath,"Data","ProjectData.json"),JSON.stringify(this.projectData))}check(){y.default.existsSync(this._dataPath)||y.default.mkdirSync(this._dataPath),y.default.existsSync(p.default.join(this._dataPath,"Data"))||y.default.mkdirSync(p.default.join(this._dataPath,"Data")),y.default.existsSync(p.default.join(this._dataPath,"Replays"))||y.default.mkdirSync(p.default.join(this._dataPath,"Replays")),y.default.existsSync(p.default.join(this._dataPath,"Results"))||y.default.mkdirSync(p.default.join(this._dataPath,"Results")),y.default.existsSync(p.default.join(this._dataPath,"Data","Settings.json"))||y.default.writeFileSync(p.default.join(this._dataPath,"Data","Settings.json"),JSON.stringify(w)),y.default.existsSync(p.default.join(this._dataPath,"Data","ProjectData.json"))||y.default.writeFileSync(p.default.join(this._dataPath,"Data","ProjectData.json"),JSON.stringify(b))}};o.default.isMainThread||!0!==o.default.workerData.HeatTrace||(h.default.parentPort.on("message",(async t=>{if("assignJob"===t.type){if(void 0===_[t.batchID]&&(_[t.batchID]=[]),"loadReplays"===t.batchType)_[t.batchID].push(await(async t=>new Promise((e=>{const s=new u(t);if(0===s.readByte()){s.readInteger();const t=s.readString();s.readString(),s.readString(),s.readShort(),s.readShort(),s.readShort(),s.readShort(),s.readShort(),s.readShort(),s.readInteger(),s.readShort(),s.readByte(),s.readInteger(),s.readString(),s.readLong();const a=s.readInteger(),i=new Uint8Array(a);for(let t=0;t<a;t++)i[t]=s.readByte();(0,c.decompress)(Buffer.from(i),void 0,(s=>{if(null===s)e({error:!0,message:"Failed To Decompress Cursor Data"});else{const a=s.toString().split(","),i=new Float64Array(a.length),r=new Float64Array(a.length),n=new Float64Array(a.length);let o=0;a.forEach(((t,e)=>{const s=t.split("|");o+=+s[0],i[e]=+s[1],r[e]=+s[2],n[e]=o})),e({error:!1,data:{beatmapHash:t,xPositions:i,yPositions:r,timeStamps:n}})}}))}else e({error:!0,message:"Unsupported Game Mode"})})))(t.data));else if("calculateHeatmap"===t.batchType)_[t.batchID].push(d(t.data.width,t.data.height,t.data.start,t.data.end,t.data.replay,1));else if("combineHeatmaps"===t.batchType){const e=new Uint32Array(t.data.width*t.data.height);t.data.heatmaps.forEach((s=>{for(let a=0;a<s.length;a+=3)e[s[a]+s[a+1]*t.data.width]+=s[a+2]})),_[t.batchID].push(e)}h.default.parentPort.postMessage({type:"jobFinished",batchID:t.batchID,jobID:t.jobID})}else if("request"===t.type){let e,s=t.data;"finishBatch"===s.type&&void 0!==_[s.batchID]&&(e=_[s.batchID],delete _[s.batchID]),h.default.parentPort.postMessage({type:"response",data:e,requestID:t.requestID})}})),h.default.parentPort.postMessage({type:"ready"})),(new class{_Core;constructor(){this._Core=new ot}state(){return this._Core.state}start(){this._Core.start()}}).start();